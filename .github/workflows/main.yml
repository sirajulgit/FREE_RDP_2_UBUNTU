name: Ubuntu-RDP-Terminal

on:
  workflow_dispatch:
    inputs:
      rdp_username:
        description: "Enter RDP Username"
        required: true
        type: string
      rdp_password:
        description: "Enter RDP Password"
        required: true
        type: string
      tailscale_authkey:
        description: "Enter Tailscale Auth Key"
        required: true
        type: string

jobs:
  rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update system
        run: sudo apt update -y

      - name: Create Terminal User
        run: |
          USERNAME="${{ github.event.inputs.rdp_username }}"
          PASSWORD="${{ github.event.inputs.rdp_password }}"
          sudo useradd -m -s /bin/bash "$USERNAME"
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo "$USERNAME"
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install XRDP & XTerm
        run: |
          sudo apt install -y xrdp xterm
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Full-screen xterm with black background
          echo "#!/bin/bash" | sudo tee /etc/xrdp/startwm.sh
          echo "export SHELL=/bin/bash" | sudo tee -a /etc/xrdp/startwm.sh
          echo "xterm -fullscreen -bg black -fg white -fa 'Monospace' -fs 14" | sudo tee -a /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh

          # Allow RDP port
          sudo iptables -I INPUT -p tcp --dport 3389 -j ACCEPT

      - name: Install & Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey="${{ github.event.inputs.tailscale_authkey }}" \
            --hostname="ubuntu-terminal-rdp-${GITHUB_RUN_ID}"
          TSIP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV

      - name: Verify XRDP
        run: |
          systemctl status xrdp --no-pager || true
          ss -tln | grep 3389 || (echo "Error: XRDP not running" && exit 1)

      - name: Show Login Info
        run: |
          echo ""
          echo "======================================"
          echo "     TERMINAL ONLY RDP LOGIN INFO     "
          echo "======================================"
          echo "IP Address : $TAILSCALE_IP"
          echo "Username   : $RDP_USER"
          echo "Password   : $RDP_PASS"
          echo "======================================"
          echo ""

      - name: Keep Alive
        run: |
          while true; do
            echo "Terminal-RDP Active â€” $(date)"
            sleep 300
          done
