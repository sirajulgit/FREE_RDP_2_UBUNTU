name: Ubuntu-RDP

on:
  workflow_dispatch:
    inputs:
      rdp_username:
        description: "Enter RDP Username"
        required: true
        type: string
      rdp_password:
        description: "Enter RDP Password"
        required: true
        type: string
      tailscale_authkey:
        description: "Enter Tailscale Auth Key"
        required: true
        type: string

jobs:
  rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update System
        run: |
          sudo apt update -y
          sudo apt install -y dbus-x11

      - name: Create RDP User
        run: |
          USERNAME="${{ github.event.inputs.rdp_username }}"
          PASSWORD="${{ github.event.inputs.rdp_password }}"

          sudo useradd -m -s /bin/bash "$USERNAME"
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo "$USERNAME"

          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install Desktop + XRDP
        run: |
          sudo apt install -y xfce4 xfce4-goodies xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Fix login session
          echo xfce4-session > /home/${{ github.event.inputs.rdp_username }}/.xsession
          sudo chown ${{ github.event.inputs.rdp_username }}:${{ github.event.inputs.rdp_username }} \
            /home/${{ github.event.inputs.rdp_username }}/.xsession

          # Fix XRDP policy
          sudo sed -i 's/console/anybody/g' /etc/X11/Xwrapper.config
          echo "allowed_users=anybody" | sudo tee /etc/X11/Xwrapper.config

      - name: Fix Firewall (Ubuntu runner does not use UFW but ensure open)
        run: |
          sudo iptables -I INPUT -p tcp --dport 3389 -j ACCEPT

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey="${{ github.event.inputs.tailscale_authkey }}" \
            --hostname="ubuntu-rdp-${GITHUB_RUN_ID}"

          TSIP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV

      - name: Confirm XRDP Running
        run: |
          if systemctl is-active --quiet xrdp; then
            echo "XRDP running."
          else
            echo "XRDP NOT running!"
            exit 1
          fi

      - name: Confirm Tailscale IP
        run: |
          echo "Tailscale IP = $TAILSCALE_IP"

      - name: Keep Alive
        run: |
          echo "============================="
          echo "  UBUNTU RDP CONNECTION INFO "
          echo "============================="
          echo "IP Address : $TAILSCALE_IP"
          echo "Username   : $RDP_USER"
          echo "Password   : $RDP_PASS"
          echo "============================="
          
          while true; do
            echo "RDP Running... $(date)"
            sleep 300
          done
